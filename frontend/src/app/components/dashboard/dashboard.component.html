<div class="dashboard-container p-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-0">AI Scrum Dashboard</h2>
      <p class="text-muted mt-2">Overview of sprint progress, work item distribution, and team performance</p>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Sprint Overview</h4>
          <div>
            <div class="d-flex align-items-center">
              <div class="input-group input-group-sm me-2" style="max-width: 250px;">
                <label class="input-group-text" for="dashboardIterationPath">Iteration Path</label>
                <input 
                  id="dashboardIterationPath"
                  type="text" 
                  class="form-control" 
                  placeholder="Enter Iteration Path" 
                  [(ngModel)]="selectedIterationPath"
                  (keyup.enter)="loadIterationData()"
                  aria-label="Iteration Path">
                <button 
                  class="btn btn-outline-primary" 
                  type="button" 
                  (click)="loadIterationData()"
                  title="Load data for this iteration path">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <button class="btn btn-primary btn-sm" (click)="reload()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="card-body" style="min-height: 316px; padding-bottom: 25px;">
          <div *ngIf="loading.sprint" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          
          <div *ngIf="error.sprint" class="alert alert-danger">
            {{ error.sprint }}
          </div>
          
          <div *ngIf="!loading.sprint && !error.sprint && sprintOverview">
            <h2 class="sprint-title">{{ decodeIterationPath(sprintOverview.sprintName) }}</h2>
            <div class="d-flex justify-content-between mt-3">
              <div>
                <p class="text-muted mb-1">Start Date</p>
                <p class="fw-bold">{{ sprintOverview.startDate | date:'longDate' }}</p>
              </div>
              <div>
                <p class="text-muted mb-1">End Date</p>
                <p class="fw-bold">{{ sprintOverview.endDate | date:'longDate' }}</p>
              </div>
              <div>
                <p class="text-muted mb-1">Days Remaining</p>
                <p class="fw-bold days-remaining">{{ sprintOverview.daysRemaining }}</p>
              </div>
            </div>
            <div class="mt-3">
              <p class="text-muted mb-1">Iteration Path</p>
              <p class="fw-bold">{{ decodeIterationPath(sprintOverview.iterationPath) }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">AI Assistant</h4>
        </div>
        <div class="card-body d-flex flex-column" style="height: 350px;">
          <!-- Chat Messages -->
          <div class="chat-messages flex-grow-1 overflow-auto mb-3">
            <div *ngIf="chatMessages.length === 0" class="text-center py-3">
              <p class="text-muted">Ask me anything about your project or tasks.</p>
              <div class="chat-examples">
                <h6 class="mb-2">Try asking me:</h6>
                <ul class="list-unstyled">
                  <li class="mb-2"><span class="badge bg-primary me-2">➤</span> What are the current sprint details?</li>
                  <li class="mb-2"><span class="badge bg-primary me-2">➤</span> How many tasks are in this sprint?</li>
                  <li class="mb-2"><span class="badge bg-primary me-2">➤</span> Show me the work distribution by team member</li>
                  <li class="mb-2"><span class="badge bg-primary me-2">➤</span> Who has the most tasks assigned?</li>
                  <li class="mb-2"><span class="badge bg-success me-2">✓</span> Assign task #123 to John</li>
                  <li class="mb-2"><span class="badge bg-primary me-2">➤</span> Suggest someone for the next task assignment</li>
                  <li class="mb-2"><span class="badge bg-primary me-2">➤</span> What's the current sprint progress?</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> Show task #48044 details</li>
                  <li class="mb-2"><span class="badge bg-warning me-2">!</span> Show blocked tasks</li>
                  <li class="mb-2"><span class="badge bg-primary me-2">➤</span> Tasks in DEV - WIP status</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> Show me the dashboard</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> Show task status distribution</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> What's the breakdown by work item type?</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> How many Active tasks?</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> Dev-New</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> Show status cards</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> No of CS-New tasks</li>
                  <li class="mb-2"><span class="badge bg-info me-2">i</span> Number of Planned tasks in Techoil\2.3.23</li>
                </ul>
              </div>
            </div>
            
            <div *ngFor="let msg of chatMessages" class="message mb-2"
                 [ngClass]="{'user-message': msg.role === 'user', 'assistant-message': msg.role === 'assistant'}">
              <div class="message-content">
                <div class="message-text" [innerHTML]="msg.content"></div>
                <div class="message-time small text-muted">{{ msg.timestamp | date:'shortTime' }}</div>
              </div>
            </div>
          </div>
          
          <!-- Chat Input -->
          <div class="chat-input">
            <div class="input-group">
              <input type="text" class="form-control" 
                     placeholder="Type your message..." 
                     [(ngModel)]="currentMessage"
                     (keyup.enter)="sendChatMessage()">
              <button class="btn btn-primary" type="button" (click)="sendChatMessage()">
                <i class="bi bi-send"></i>
              </button>
            </div>
            <div class="mt-2 text-center small text-muted">
              <span class="badge bg-success me-1">New!</span> 
              You can now assign tasks by typing: "Assign task #123 to John"
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Distribution Cards -->
  <div class="card mb-4">
    <div class="card-header">
      <h4 class="mb-0">Task Distribution by Status</h4>
    </div>
    <div class="card-body">
      <!-- Loading indicator -->
      <div *ngIf="loadingTaskDetails" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading work item data...</span>
        </div>
        <p class="mt-2">Fetching real-time work item counts from API...</p>
      </div>
      
      <!-- Error message -->
      <div *ngIf="taskDetailsError" class="alert alert-danger">
        {{ taskDetailsError }}
      </div>
      
      <!-- No data message -->
      <div *ngIf="!loadingTaskDetails && (!taskStatusBoard || taskStatusBoard.length === 0) && !taskDetailsError" class="text-center py-4">
        <p class="text-muted">No work item state data available. Please select an iteration and click Search.</p>
      </div>
      
      <!-- Task Status Cards -->
      <div *ngIf="!loadingTaskDetails && taskStatusBoard && taskStatusBoard.length > 0" class="row g-3">
        <div *ngFor="let status of taskStatusBoard" class="col-md-2 col-sm-4 col-6 mb-3">
          <div class="card task-state-card h-100" 
               [ngClass]="{
                 'status-active': status.status === 'Active',
                 'status-code-review': status.status === 'Code Review',
                 'status-dev-progress': status.status === 'Dev In Progress' || status.status === 'Dev In progress' || status.status.toLowerCase().includes('dev') && status.status.toLowerCase().includes('progress'),
                 'status-dev-new': status.status === 'Dev-New' || status.status === 'New',
                 'status-planned': status.status === 'Planned',
                 'status-cs-new': status.status === 'CS-New' || status.status === 'CS-new',
                 'status-proposed': status.status === 'Proposed',
                 'status-clarification': status.status === 'Require Clarification' || status.status.toLowerCase().includes('clarification'),
                 'status-resolved': status.status === 'Resolved' || status.status === 'Done' || status.status === 'Completed',
                 'status-verified': status.status === 'Verified' || status.status === 'Validated'
               }"
               (click)="showTasksForStatus(status.status)" 
               style="cursor: pointer;"
               title="Click to view tasks">
            <div class="card-body text-center text-white p-3">
              <div class="text-2xl font-bold mb-1">{{ status.count }}</div>
              <div class="text-lg">{{ status.status }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Task Distribution by Type -->
  <div class="card mb-4">
    <div class="card-header">
      <h4 class="mb-0">Work Items by Type</h4>
    </div>
    <div class="card-body">
      <!-- Type Distribution Cards -->
      <div *ngIf="!loadingTaskDetails && tasksByType && tasksByType.length > 0" class="row">
        <div *ngFor="let typeItem of tasksByType" class="col-md-3 mb-3">
          <div class="card task-type-card h-100" [style.border-left-color]="typeItem.color">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0 card-title">{{ typeItem.type }}</h5>
                <span class="badge rounded-pill" [style.background-color]="typeItem.color">{{ typeItem.count }}</span>
              </div>
              <div class="progress">
                <div class="progress-bar" [style.width.%]="(typeItem.count / getTotalWorkItems()) * 100" 
                     [style.background-color]="typeItem.color">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- No data message -->
      <div *ngIf="!loadingTaskDetails && (!tasksByType || tasksByType.length === 0) && !taskDetailsError" class="text-center py-4">
        <p class="text-muted">No work item type data available.</p>
      </div>
    </div>
  </div>
</div>

<!-- Task Status Modal -->
<div class="modal fade" id="taskStatusModal" tabindex="-1" aria-labelledby="taskStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" [ngClass]="{'status-active-header': selectedStatus === 'Active',
                                           'status-code-review-header': selectedStatus === 'Code Review',
                                           'status-dev-progress-header': selectedStatus === 'Dev In Progress' || selectedStatus === 'Dev In progress',
                                           'status-dev-new-header': selectedStatus === 'Dev-New' || selectedStatus === 'New',
                                           'status-planned-header': selectedStatus === 'Planned',
                                           'status-cs-new-header': selectedStatus === 'CS-New' || selectedStatus === 'CS-new',
                                           'status-proposed-header': selectedStatus === 'Proposed',
                                           'status-clarification-header': selectedStatus === 'Require Clarification',
                                           'status-resolved-header': selectedStatus === 'Resolved' || selectedStatus === 'Done' || selectedStatus === 'Completed',
                                           'status-verified-header': selectedStatus === 'Verified' || selectedStatus === 'Validated' }">
        <h5 class="modal-title" id="taskStatusModalLabel">Tasks with Status: {{ selectedStatus }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="loadingStatusTasks" class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading tasks...</span>
          </div>
          <p class="mt-2">Fetching tasks with status: {{ selectedStatus }}</p>
        </div>
        
        <div *ngIf="!loadingStatusTasks && statusTasks.length === 0" class="alert alert-info">
          No tasks found with status: {{ selectedStatus }}
        </div>
        
        <div *ngIf="!loadingStatusTasks && statusTasks.length > 0">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Assigned To</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let task of statusTasks">
                <td><a [href]="getTaskUrl(task.id)" target="_blank">#{{ task.id }}</a></td>
                <td>{{ task.title }}</td>
                <td>{{ task.assignedTo || 'Unassigned' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div> 