<div class="container-fluid p-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-0">ML-Based Task Estimation</h2>
      <p class="text-muted mt-2">Estimate task duration using machine learning predictions based on historical data</p>
    </div>
  </div>

  <!-- Iteration Path Selection -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title mb-0">Enter Iteration Path</h4>
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-md-6">
              <div class="input-group">
                <label class="input-group-text" for="manualIterationPath">Iteration Path</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="manualIterationPath" 
                  [(ngModel)]="manualIterationPath"
                  placeholder="Enter iteration path (e.g. Techoil\2.3.23)" 
                  aria-label="Manual Iteration Path">
                <button 
                  class="btn btn-outline-primary" 
                  type="button" 
                  (click)="loadWorkItemsByIteration()"
                  [disabled]="!manualIterationPath">
                  <i class="bi bi-search"></i> Load Items
                </button>
              </div>
              <div *ngIf="iterationError" class="text-danger mt-2">
                <small>{{ iterationError }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Work Items List -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="card-title mb-0">Work Items</h4>
          <span *ngIf="workItems.length > 0" class="badge bg-primary">{{ workItems.length }} items</span>
        </div>
        <div class="card-body">
          <!-- Loading indicator -->
          <div *ngIf="loadingIterationItems" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading work items...</span>
            </div>
            <p class="mt-2 text-muted">Loading work items...</p>
          </div>
          
          <!-- No items message -->
          <div *ngIf="!loadingIterationItems && workItems.length === 0 && !iterationError" class="text-center py-4">
            <p class="text-muted">No work items found. Please select an iteration path and click "Load Items".</p>
          </div>
          
          <!-- Work items table -->
          <div *ngIf="!loadingIterationItems && workItems.length > 0" class="table-responsive">
            <table class="table table-hover table-striped">
              <thead>
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Type</th>
                  <th scope="col">Title</th>
                  <th scope="col">Assignee</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of workItems" 
                    [class.table-primary]="selectedWorkItem?.id === item.id"
                    (click)="selectWorkItem(item)"
                    style="cursor: pointer;">
                  <td class="fw-bold">#{{ item.id }}</td>
                  <td>
                    <span class="badge rounded-pill" [ngClass]="{
                      'bg-danger': item.type === 'Bug' || (item.fields && item.fields['System.WorkItemType'] === 'Bug'),
                      'bg-primary': item.type === 'Feature' || (item.fields && item.fields['System.WorkItemType'] === 'Feature'),
                      'bg-warning': item.type === 'Change Request' || (item.fields && item.fields['System.WorkItemType'] === 'Change Request'),
                      'bg-info': item.type === 'Test' || (item.fields && item.fields['System.WorkItemType'] === 'Test'),
                      'bg-success': item.type === 'Requirement' || (item.fields && item.fields['System.WorkItemType'] === 'Requirement'),
                      'bg-dark text-light': item.type === 'User Story' || (item.fields && item.fields['System.WorkItemType'] === 'User Story'),
                      'bg-secondary': !item.type && (!item.fields || !item.fields['System.WorkItemType'])
                    }">{{ (item.fields && item.fields['System.WorkItemType']) || item.type || 'Task' }}</span>
                  </td>
                  <td>{{ item.title }}</td>
                  <td><small><i class="bi bi-person me-1"></i>{{ getAssigneeName(item) || 'Unassigned' }}</small></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Task Estimation Form -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title mb-0">
            <span *ngIf="selectedWorkItem">Task #{{ selectedWorkItem.id }} Details</span>
            <span *ngIf="!selectedWorkItem">Task Details</span>
          </h4>
        </div>
        <div class="card-body">
          <form [formGroup]="estimationForm" (ngSubmit)="estimateTaskTime()">
            <!-- Task Title -->
            <div class="mb-3">
              <label for="taskTitle" class="form-label">Task Title</label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  id="taskTitle" 
                  formControlName="title"
                  placeholder="Enter or select task title"
                  [ngClass]="{'is-valid': selectedWorkItem !== null}">
                <button 
                  *ngIf="estimationForm.get('title')?.value"
                  class="btn btn-outline-secondary" 
                  type="button"
                  (click)="resetForm()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <div *ngIf="estimationForm.get('title')?.invalid && estimationForm.get('title')?.touched" class="text-danger mt-1">
                <small *ngIf="estimationForm.get('title')?.errors?.['required']">Title is required</small>
                <small *ngIf="estimationForm.get('title')?.errors?.['minlength']">Title must be at least 5 characters</small>
              </div>
              <div *ngIf="selectedWorkItem" class="text-success mt-1">
                <small>Found matching work item #{{ selectedWorkItem.id }}</small>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <!-- Task Type -->
                <div class="mb-3">
                  <label for="taskType" class="form-label">Task Type</label>
                  <select class="form-select" id="taskType" formControlName="type">
                    <option *ngFor="let type of taskTypes" [value]="type">{{ type }}</option>
                  </select>
                </div>
              </div>
              
              <div class="col-md-6">
                <!-- Assignee -->
                <div class="mb-3">
                  <label for="assignee" class="form-label">Assignee</label>
                  <select class="form-select" id="assignee" formControlName="assignee">
                    <option value="">-- Unassigned --</option>
                    <option *ngFor="let member of teamMembers" [value]="member">{{ member }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Test Cases Upload -->
            <div class="mb-3">
              <label for="testCasesUpload" class="form-label">Upload Test Cases</label>
              <div class="input-group">
                <input 
                  type="file" 
                  class="form-control" 
                  id="testCasesUpload" 
                  accept=".xlsx,.xls,.csv,.txt"
                  (change)="onTestCasesUpload($event)">
                <button 
                  class="btn btn-outline-secondary" 
                  type="button"
                  [disabled]="!testCasesFile"
                  (click)="clearTestCases()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <div *ngIf="testCasesFile" class="text-success mt-1">
                <small><i class="bi bi-check-circle"></i> Test cases uploaded: {{ testCasesFile?.name }}</small>
              </div>
              <div *ngIf="testCaseCount > 0" class="mt-2">
                <div class="alert alert-info py-2">
                  <small><i class="bi bi-info-circle"></i> <strong>{{ testCaseCount }}</strong> test cases detected. This will be factored into the estimation.</small>
                </div>
              </div>
            </div>

            <!-- User Story Reference -->
            <div class="mb-3">
              <label for="userStoryId" class="form-label">Related User Story</label>
              <div class="input-group">
                <span class="input-group-text">#</span>
                <input 
                  type="text" 
                  class="form-control" 
                  id="userStoryId" 
                  formControlName="userStoryId"
                  placeholder="Enter user story ID">
                <button 
                  class="btn btn-outline-primary" 
                  type="button"
                  [disabled]="!estimationForm.get('userStoryId')?.value"
                  (click)="checkUserStory()">
                  <i class="bi bi-search"></i> Check
                </button>
              </div>
              <div *ngIf="userStoryDetails" class="mt-2">
                <div class="alert alert-success py-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <small><i class="bi bi-journal-check"></i> User Story #{{ userStoryDetails.id }} linked</small>
                    </div>
                    <div>
                      <span class="badge bg-info">{{ userStoryDetails.points || 'N/A' }} Points</span>
                    </div>
                  </div>
                  <div class="mt-1">
                    <small class="text-muted">{{ userStoryDetails.title }}</small>
                  </div>
                </div>
              </div>
              <div *ngIf="userStoryError" class="text-danger mt-1">
                <small>{{ userStoryError }}</small>
              </div>
            </div>

            <!-- Complexity -->
            <div class="mb-3">
              <label class="form-label">Complexity</label>
              <div class="d-flex">
                <div class="form-check me-3" *ngFor="let level of complexityLevels">
                  <input 
                    class="form-check-input" 
                    type="radio" 
                    [id]="'complexity-' + level.toLowerCase()" 
                    [value]="level" 
                    formControlName="complexity">
                  <label class="form-check-label" [for]="'complexity-' + level.toLowerCase()">
                    {{ level }}
                  </label>
                </div>
              </div>
              <div *ngIf="selectedWorkItem" class="text-muted mt-1">
                <small><i class="bi bi-info-circle"></i> Complexity automatically predicted based on work item attributes</small>
              </div>
            </div>
            
            <!-- Estimation Method Toggle -->
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-person-workspace me-1"></i> Human Development Estimates
              </label>
              <div class="bg-light p-3 rounded">
                <div class="row">
                  <div class="col-md-6">
                    <label for="manualDevHours" class="form-label">Development Hours</label>
                    <div class="input-group mb-2">
                      <input 
                        type="number" 
                        class="form-control" 
                        id="manualDevHours" 
                        formControlName="manualDevHours"
                        min="0.5" 
                        step="0.5"
                        placeholder="Enter development hours">
                      <span class="input-group-text">hours</span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="manualTestHours" class="form-label">Testing Hours</label>
                    <div class="input-group mb-0">
                      <input 
                        type="number" 
                        class="form-control" 
                        id="manualTestHours" 
                        formControlName="manualTestHours"
                        min="0.5" 
                        step="0.5"
                        placeholder="Enter testing hours">
                      <span class="input-group-text">hours</span>
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Direct human assessment without AI assistance
                  </small>
                  <small class="text-primary">
                    Total: <strong>{{ humanTotalHours }}</strong> hours
                  </small>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-secondary" (click)="resetForm()">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="loading">
                <span *ngIf="!loading">
                  <i class="bi bi-stopwatch"></i> Estimate Time
                </span>
                <span *ngIf="loading">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Estimating...
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <!-- Error Display -->
      <div *ngIf="error" class="alert alert-danger mb-4">
        {{ error }}
      </div>

      <!-- Estimation Results -->
      <div *ngIf="showResult && estimationResult" class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="card-title mb-0">
            <i class="bi bi-graph-up me-2"></i>Estimation Comparison
          </h4>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- AI Estimation -->
            <div class="col-md-6">
              <div class="card h-100 mb-0">
                <div class="card-header bg-info text-white">
                  <h5 class="card-title mb-0">
                    <i class="bi bi-robot me-2"></i>AI Estimation
                  </h5>
                </div>
                <div class="card-body">
                  <div class="mb-4 text-center">
                    <h2 class="display-5 mb-0">{{ estimationResult.estimatedHours }} hours</h2>
                    <p class="text-muted">AI estimated time</p>
                  </div>

                  <div class="row text-center mb-3">
                    <div class="col-6">
                      <div class="p-2 bg-light rounded">
                        <h5 class="mb-0">{{ devTimeEstimate }}</h5>
                        <p class="text-muted mb-0 small">Development</p>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="p-2 bg-light rounded">
                        <h5 class="mb-0">{{ testTimeEstimate }}</h5>
                        <p class="text-muted mb-0 small">Testing</p>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <h6>Confidence</h6>
                    <div class="progress">
                      <div 
                        class="progress-bar" 
                        [ngClass]="getConfidenceClass(estimationResult.confidenceScore)"
                        [style.width.%]="estimationResult.confidenceScore * 100" 
                        role="progressbar" 
                        [attr.aria-valuenow]="estimationResult.confidenceScore * 100" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                        {{ formatConfidence(estimationResult.confidenceScore) }}
                      </div>
                    </div>
                  </div>

                  <h6>Factors Considered</h6>
                  <ul class="list-group list-group-flush small">
                    <li class="list-group-item px-0" *ngFor="let factor of estimationResult.factors">
                      {{ factor }}
                    </li>
                    <!-- Show test cases factor if test cases were provided -->
                    <li class="list-group-item px-0" *ngIf="testCaseCount > 0">
                      <i class="bi bi-checklist"></i> {{ testCaseCount }} test cases included in estimation
                    </li>
                    <!-- Show user story factor if a user story was linked -->
                    <li class="list-group-item px-0" *ngIf="userStoryDetails">
                      <i class="bi bi-journal-text"></i> User Story #{{ userStoryDetails.id }} ({{ userStoryDetails.points }} points)
                    </li>
                  </ul>
                </div>
                <div class="card-footer bg-light small">
                  <i class="bi bi-info-circle"></i> Based on historical data and ML algorithms
                </div>
              </div>
            </div>

            <!-- Human Estimation -->
            <div class="col-md-6">
              <div class="card h-100 mb-0">
                <div class="card-header bg-success text-white">
                  <h5 class="card-title mb-0">
                    <i class="bi bi-person me-2"></i>Human Estimation
                  </h5>
                </div>
                <div class="card-body">
                  <div class="mb-4 text-center">
                    <h2 class="display-5 mb-0">{{ humanTotalHours }} hours</h2>
                    <p class="text-muted">Human estimated time</p>
                  </div>

                  <div class="row text-center mb-3">
                    <div class="col-6">
                      <div class="p-2 bg-light rounded">
                        <h5 class="mb-0">{{ humanDevHours }}</h5>
                        <p class="text-muted mb-0 small">Development</p>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="p-2 bg-light rounded">
                        <h5 class="mb-0">{{ humanTestHours }}</h5>
                        <p class="text-muted mb-0 small">Testing</p>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <h6>Confidence</h6>
                    <div class="progress">
                      <div 
                        class="progress-bar bg-success" 
                        style="width: 100%" 
                        role="progressbar" 
                        aria-valuenow="100" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                        100%
                      </div>
                    </div>
                  </div>

                  <h6>Factors Considered</h6>
                  <ul class="list-group list-group-flush small">
                    <li class="list-group-item px-0">
                      <i class="bi bi-check-circle-fill text-success"></i> Manual development effort assessment
                    </li>
                    <li class="list-group-item px-0">
                      <i class="bi bi-check-circle-fill text-success"></i> Professional judgment
                    </li>
                    <li class="list-group-item px-0">
                      Task type: {{ estimationForm.get('type')?.value }}
                    </li>
                    <li class="list-group-item px-0">
                      {{ estimationForm.get('complexity')?.value }} complexity
                    </li>
                    <li class="list-group-item px-0" *ngIf="testCaseCount > 0">
                      <i class="bi bi-checklist"></i> {{ testCaseCount }} test cases considered
                    </li>
                  </ul>
                </div>
                <div class="card-footer bg-light small">
                  <i class="bi bi-info-circle"></i> Based on developer expertise and direct coding knowledge
                </div>
              </div>
            </div>
          </div>

          <!-- Comparison and Differential -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="alert" [ngClass]="{
                'alert-success': humanTotalHours >= estimationResult.estimatedHours,
                'alert-warning': humanTotalHours < estimationResult.estimatedHours
              }">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">Estimation Comparison</h5>
                    <p class="mb-0">
                      <span *ngIf="humanTotalHours > estimationResult.estimatedHours">
                        Human estimate is <strong>{{ (humanTotalHours - estimationResult.estimatedHours).toFixed(1) }} hours higher</strong> than AI estimate
                      </span>
                      <span *ngIf="humanTotalHours < estimationResult.estimatedHours">
                        Human estimate is <strong>{{ (estimationResult.estimatedHours - humanTotalHours).toFixed(1) }} hours lower</strong> than AI estimate
                      </span>
                      <span *ngIf="humanTotalHours === estimationResult.estimatedHours">
                        <strong>Both estimates are identical</strong> at {{ humanTotalHours }} hours
                      </span>
                    </p>
                  </div>
                  <div>
                    <div class="badge bg-dark p-2">
                      <span class="h5 mb-0">{{ (humanTotalHours / estimationResult.estimatedHours * 100).toFixed(0) }}%</span>
                      <small class="d-block">of AI estimate</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer text-muted small">
          <i class="bi bi-lightbulb"></i> Combining both estimation approaches provides a more reliable forecast and helps identify potential gaps in the estimate.
        </div>
      </div>

      <!-- Placeholder when no result is shown -->
      <div *ngIf="!showResult && !error" class="card bg-light">
        <div class="card-body text-center p-5">
          <i class="bi bi-graph-up display-1 text-muted"></i>
          <h4 class="mt-3">Task Time Prediction</h4>
          <p class="text-muted">Fill in the task details and click "Estimate Time" to get both AI and human time estimates</p>
        </div>
      </div>
    </div>
  </div>
</div> 