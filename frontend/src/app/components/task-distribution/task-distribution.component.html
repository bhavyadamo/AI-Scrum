<div class="container-fluid p-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">Task Distribution</h2>
        <div>
          <!-- Manual Input Form -->
          <div class="search-section">
            <!-- Grouped inputs with blue background -->
            <div class="input-group-container">
              <!-- Team Filter Checkbox and Label -->
              <div class="filter-checkbox">
                <input type="checkbox" class="form-check-input" id="applyTeamFilter" [(ngModel)]="applyTeamFilter"
                  [disabled]="loading.tasks || loading.members">
                <label class="form-check-label" for="applyTeamFilter">Apply Team Filter</label>
              </div>
              
              <!-- Team Name Input -->
              <div class="search-input team-input">
                <input type="text" class="form-control" placeholder="Team Name" [(ngModel)]="teamName" 
                  [disabled]="loading.tasks || loading.members">
                <small class="text-muted">TeamName</small>
              </div>
              
              <!-- Iteration Path Input -->
              <div class="search-input">
                <input type="text" class="form-control" placeholder="Iteration Path" [(ngModel)]="manualIterationPath" 
                  [disabled]="loading.tasks || loading.members" list="iterationPathsList">
                <small class="text-muted">IterationPath</small>
                
                <!-- Datalist for iteration path suggestions -->
                <datalist id="iterationPathsList">
                  <option *ngFor="let path of iterationPaths" [value]="path"></option>
                </datalist>
              </div>
              
              <!-- Search Button -->
              <button class="btn btn-primary search-btn" (click)="searchClicked()" [disabled]="loading.tasks || loading.members">
                <i class="bi bi-search me-1"></i>
                <span *ngIf="!loading.tasks && !loading.members">Search</span>
                <span *ngIf="loading.tasks || loading.members">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Loading...
                </span>
              </button>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
              <!-- Auto Assign Button -->
              <button class="btn btn-primary auto-assign-btn" (click)="showAutoAssignPreview()" [disabled]="loading.autoAssign || loading.preview">
                <i class="bi bi-magic"></i> 
                <span *ngIf="!loading.autoAssign && !loading.preview">Auto-Assign Tasks</span>
                <span *ngIf="loading.preview">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Loading Preview...
                </span>
                <span *ngIf="loading.autoAssign">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Assigning...
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <p class="text-muted mt-2">Manage and assign tasks for the current sprint</p>
      <div *ngIf="error.autoAssign" class="alert alert-danger">{{ error.autoAssign }}</div>
      <div *ngIf="error.iterationPaths" class="alert alert-warning">{{ error.iterationPaths }}</div>
      <div *ngIf="error.tasks" class="alert alert-danger">{{ error.tasks }}</div>
      <div *ngIf="error.members" class="alert alert-danger">{{ error.members }}</div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-4" id="taskTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="task-distribution-tab" data-bs-toggle="tab" data-bs-target="#task-distribution" type="button" role="tab" aria-controls="task-distribution" aria-selected="true" (click)="onTabChange('distribution')">
        <i class="bi bi-list-task me-2"></i>Task Distribution
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="task-workload-tab" data-bs-toggle="tab" data-bs-target="#task-workload" type="button" role="tab" aria-controls="task-workload" aria-selected="false" (click)="onTabChange('workload')">
        <i class="bi bi-bar-chart-line me-2"></i>Task Workload
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="taskTabsContent">
    <!-- Task Distribution Tab -->
    <div class="tab-pane fade show active" id="task-distribution" role="tabpanel" aria-labelledby="task-distribution-tab">
      <!-- Tasks Table -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div *ngIf="loading.tasks" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading tasks...</span>
                </div>
              </div>

              <div *ngIf="error.tasks" class="alert alert-danger">{{ error.tasks }}</div>

              <div *ngIf="!loading.tasks && !error.tasks && tasks.length === 0" class="text-center py-4">
                <p class="text-muted">No tasks found for the current iteration path.</p>
              </div>

              <div *ngIf="!loading.tasks && !error.tasks && tasks.length > 0" class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Title</th>
                      <th>Priority</th>
                      <th>Assigned To</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let task of filteredTasks">
                      <td>
                        <a href="#" (click)="openTaskInAzureDevOps(task.id, $event)" class="task-id-link">{{ task.id }}</a>
                      </td>
                      <td>{{ task.title }}</td>
                      <td>
                        <span class="badge rounded-pill" [ngClass]="getPriorityClass(task.priority)">
                          {{ task.priority }}
                        </span>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <span *ngIf="task.assignedTo" class="me-2">{{ task.assignedTo }}</span>
                          <span *ngIf="!task.assignedTo" class="text-muted me-2">Unassigned</span>
                          <div *ngIf="task.autoAssignSuggestion" class="ms-1 suggestion-box">
                            <small class="text-primary">
                              <i class="bi bi-lightbulb-fill"></i> 
                              Suggest: {{ task.autoAssignSuggestion }}
                            </small>
                          </div>
                        </div>
                      </td>

                      <td>
                        <button class="btn btn-primary btn-sm" (click)="openAssignModal(task.id)">
                          <i class="bi bi-person-plus"></i> Assign
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Task Workload Tab -->
    <div class="tab-pane fade" id="task-workload" role="tabpanel" aria-labelledby="task-workload-tab">
      <!-- Team Workload Overview -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="mb-0">Team Workload</h4>
              <button class="btn btn-outline-primary btn-sm" (click)="loadTeamMembers(); loadTeamMemberTaskCounts()">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
              </button>
            </div>
            <div class="card-body">
              <div *ngIf="loading.members" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading team members...</span>
                </div>
              </div>

              <div *ngIf="error.members" class="alert alert-danger">{{ error.members }}</div>

              <div *ngIf="!loading.members && !error.members && filteredTeamMembers.length === 0" class="text-center py-4">
                <p class="text-muted">No team members found for the current iteration path.</p>
              </div>

              <div *ngIf="!loading.members && !error.members && filteredTeamMembers.length > 0" class="row">
                <div *ngFor="let member of filteredTeamMembers" class="col-md-3 col-sm-6 mb-3">
                  <div class="card team-member-card h-100" [ngClass]="{'bg-light': getTaskCount(member.displayName) === 0}">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="#" class="member-name-link" (click)="showMemberTasksModal($event, member.displayName)" 
                           [attr.aria-label]="'View ' + member.displayName + '\'s tasks'">
                          {{ member.displayName }}
                        </a>
                      </h5>
                      <div class="workload-stats mt-2">
                        <span class="badge rounded-pill task-count-badge" 
                              [ngClass]="getTeamMemberWorkloadClass(getTaskCount(member.displayName))"
                              (click)="showMemberTasks($event, member.displayName)"
                              style="cursor: pointer;">
                          {{ getTaskCount(member.displayName) }} Tasks
                        </span>
                      </div>
                      <div class="progress mt-2">
                        <div class="progress-bar" 
                            [ngClass]="getProgressBarClass(getTaskCount(member.displayName))"
                            [style.width.%]="getWorkloadPercentage(getTaskCount(member.displayName))" 
                            role="progressbar" 
                            [attr.aria-valuenow]="getTaskCount(member.displayName)" 
                            aria-valuemin="0" 
                            aria-valuemax="10">
                        </div>
                      </div>
                      <div *ngIf="member.email" class="text-muted mt-2 small">
                        <i class="bi bi-envelope"></i> {{ member.email }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Task Modal -->
  <div class="modal" [ngClass]="{'show': selectedTask !== null}" [style.display]="selectedTask !== null ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Assign Task</h5>
          <button type="button" class="btn-close" (click)="cancelAssign()"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="error.assign" class="alert alert-danger mb-3">{{ error.assign }}</div>
          
          <div *ngIf="selectedTask !== null">
            <div class="mb-3">
              <label class="form-label fw-bold">Task ID</label>
              <div class="py-2 px-3 bg-light rounded">{{ selectedTask }}</div>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Task Title</label>
              <div class="py-2 px-3 bg-light rounded">
                {{ getSelectedTaskTitle() }}
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <label for="teamMemberSelect" class="form-label fw-bold mb-2">Select Team Member</label>
            
            <!-- Team Member Selection List -->
            <div class="team-member-options">
              <div class="form-check mb-2 border p-2 rounded" *ngFor="let member of filteredTeamMembers">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [id]="'member-' + member.id" 
                  [value]="member.displayName" 
                  [(ngModel)]="selectedMember" 
                  name="teamMemberRadio">
                <label class="form-check-label w-100" [attr.for]="'member-' + member.id">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="member-name">{{ member.displayName }}</span>
                    <span class="badge rounded-pill" [ngClass]="getTeamMemberWorkloadClass(getTaskCount(member.displayName))">
                      {{ getTaskCount(member.displayName) }} Tasks
                    </span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelAssign()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="assignTask()" [disabled]="loading.assign || !selectedMember">
            <span *ngIf="!loading.assign">Assign</span>
            <span *ngIf="loading.assign">
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              Assigning...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="selectedTask !== null"></div>
  
  <!-- Auto-Assign Preview Modal -->
  <div class="modal" [ngClass]="{'show': showingPreview}" [style.display]="showingPreview ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-magic me-2"></i> Auto-Assign Preview
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="cancelAutoAssignPreview()"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="error.preview" class="alert alert-danger mb-3">{{ error.preview }}</div>
          
          <div class="alert alert-primary mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Preview Mode:</strong> Review AI-suggested assignments before confirming. No changes will be made until you click "Confirm & Assign".
          </div>
          
          <!-- Loading state -->
          <div *ngIf="loading.preview" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading assignment suggestions...</span>
            </div>
            <p class="mt-2">Analyzing tasks and developer performance...</p>
          </div>
          
          <!-- No tasks to assign -->
          <div *ngIf="!loading.preview && assignPreviewTasks.length === 0" class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No "Dev-New" tasks available for assignment.
          </div>
          
          <!-- Debugging information -->
          <div *ngIf="!loading.preview && assignPreviewTasks.length === 0" class="mt-3">
            <div class="accordion" id="debugAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    <i class="bi bi-bug me-2"></i> Debug Information
                  </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#debugAccordion">
                  <div class="accordion-body">
                    <h6>Total Tasks: {{ tasks.length }}</h6>
                    <h6>Total Tasks: {{ filteredTasks.length }} (filtered from {{ tasks.length }} total)</h6>
                    <div *ngIf="filteredTasks.length > 0">
                      <h6>Status Distribution:</h6>
                      <ul>
                        <li *ngFor="let status of getStatusDistribution()">
                          {{ status.status }}: {{ status.count }}
                        </li>
                      </ul>
                      
                      <h6>Dev-New Tasks ({{ getDevNewTasks().length }}):</h6>
                      <div class="table-responsive" *ngIf="getDevNewTasks().length > 0">
                        <table class="table table-sm table-bordered">
                          <thead>
                            <tr>
                              <th>ID</th>
                              <th>Title</th>
                              <th>Status</th>
                              <th>Assigned To</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let task of getDevNewTasks()">
                              <td>
                                <a href="#" (click)="openTaskInAzureDevOps(task.id, $event)" class="task-id-link">{{ task.id }}</a>
                              </td>
                              <td>{{ task.title }}</td>
                              <td>{{ task.status }}</td>
                              <td>{{ task.assignedTo || 'Unassigned' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      
                      <div *ngIf="getDevNewTasks().length === 0" class="alert alert-warning">
                        No tasks with 'Dev-New' status found in the data.
                      </div>
                      
                      <div *ngIf="getUnassignedDevNewTasks().length === 0 && getDevNewTasks().length > 0" class="alert alert-warning">
                        Found {{ getDevNewTasks().length }} Dev-New tasks, but all are already assigned.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Preview table -->
          <div *ngIf="!loading.preview && assignPreviewTasks.length > 0">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Current Assignee</th>
                    <th>Suggested Assignee</th>
                    <th>Assignment Logic</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let task of assignPreviewTasks">
                    <td>
                      <a href="#" (click)="openTaskInAzureDevOps(task.id, $event)" class="task-id-link">{{ task.id }}</a>
                    </td>
                    <td>
                      <span class="badge bg-info text-dark">{{ task.type }}</span>
                    </td>
                    <td>{{ task.title }}</td>
                    <td>
                      <span class="badge bg-secondary">{{ task.status }}</span>
                    </td>
                    <td>
                      <span *ngIf="task.assignedTo" class="text-muted">{{ task.assignedTo }}</span>
                      <span *ngIf="!task.assignedTo" class="badge bg-warning text-dark">Unassigned</span>
                    </td>
                    <td>
                      <ng-container *ngIf="assignPreviewSuggestions[task.id]">
                        <div class="d-flex align-items-center">
                          <span class="badge bg-success me-2">AI Pick</span>
                          <strong>{{ extractDeveloperName(assignPreviewSuggestions[task.id]) }}</strong>
                          <span *ngIf="extractDeveloperName(assignPreviewSuggestions[task.id]) !== task.assignedTo && task.assignedTo" 
                                class="ms-2 badge bg-warning text-dark">Reassignment</span>
                        </div>
                      </ng-container>
                      <span *ngIf="!assignPreviewSuggestions[task.id]" class="text-muted">No suggestion available</span>
                    </td>
                    <td>
                      <span *ngIf="assignPreviewSuggestions[task.id]" class="text-muted small">
                        {{ extractLogicExplanation(assignPreviewSuggestions[task.id]) }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Assignment Logic Legend -->
            <div class="mt-4">
              <h6>Assignment Logic Explanation:</h6>
              <ul class="list-unstyled row">
                <li class="col-md-6 mb-2">
                  <i class="bi bi-trophy text-warning me-2"></i>
                  <small><strong>Past Expertise</strong> - Completed similar tasks in the past 3 months</small>
                </li>
                <li class="col-md-6 mb-2">
                  <i class="bi bi-check-circle text-success me-2"></i>
                  <small><strong>Recent Completion</strong> - Recently completed tasks with no active work</small>
                </li>
                <li class="col-md-6 mb-2">
                  <i class="bi bi-speedometer2 text-info me-2"></i>
                  <small><strong>Low Workload</strong> - Developer with few active tasks</small>
                </li>
                <li class="col-md-6 mb-2">
                  <i class="bi bi-person-plus text-primary me-2"></i>
                  <small><strong>Least Assigned</strong> - Developer with lowest total task count</small>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelAutoAssignPreview()">Cancel</button>
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="confirmAutoAssign()" 
            [disabled]="loading.autoAssign || !assignPreviewTasks || assignPreviewTasks.length === 0 || !hasAssignmentSuggestions()">
            <i class="bi bi-magic me-2"></i>
            <span *ngIf="!loading.autoAssign">Confirm & Assign</span>
            <span *ngIf="loading.autoAssign">
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              Assigning...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showingPreview"></div>
  
  <!-- Task List Popup -->
  <div class="task-popup" *ngIf="showTaskPopup" 
       (click)="keepPopupOpen($event)"
       [style.top.px]="popupPosition.top" 
       [style.left.px]="popupPosition.left">
    <div class="task-popup-header">
      <h5>{{ selectedMemberName }}'s Tasks</h5>
      <button type="button" class="btn-close" (click)="closePopup()"></button>
    </div>
    <div class="task-popup-body">
      <div *ngIf="selectedMemberTasks.length === 0" class="text-center py-3">
        <p class="text-muted mb-0">No tasks found for this team member.</p>
      </div>
      <ul class="task-list" *ngIf="selectedMemberTasks.length > 0">
        <li *ngFor="let task of selectedMemberTasks" class="task-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <a href="#" (click)="openTaskInAzureDevOps(task.id, $event)" class="task-id-link">{{ task.id }}</a>
              <span class="ms-2">{{ task.title }}</span>
            </div>
            <span class="status-badge" [ngClass]="getStatusClass(task.status)">
              {{ task.status }}
            </span>
          </div>
        </li>
      </ul>
    </div>
  </div>
  
  <!-- Member Tasks Modal -->
  <div class="member-modal-backdrop" *ngIf="showMemberModal" (click)="closeMemberModal()">
    <div class="member-modal" (click)="$event.stopPropagation()" (keydown)="handleModalKeydown($event)" role="dialog" aria-modal="true" 
         [attr.aria-labelledby]="'memberModalTitle'" tabindex="-1">
      <div class="member-modal-content">
        <div class="member-modal-header">
          <h2 class="member-modal-title" id="memberModalTitle">
            <i class="bi bi-person-badge me-2"></i>{{ selectedModalMemberName }}'s Tasks
          </h2>
          <button type="button" class="member-modal-close" aria-label="Close" (click)="closeMemberModal()">
            <i class="bi bi-x" style="font-size: 1.5rem;"></i>
          </button>
        </div>
        
        <!-- Loading State -->
        <div class="member-modal-loading" *ngIf="loading.memberTasks">
          <div class="spinner" role="status"></div>
          <p class="loading-text">Loading tasks...</p>
        </div>
        
        <!-- Error State -->
        <div class="member-modal-error" *ngIf="error.memberTasks">
          <i class="bi bi-exclamation-circle me-2"></i>
          {{ error.memberTasks }}
        </div>
        
        <!-- Content -->
        <div class="px-4 py-3" *ngIf="!loading.memberTasks && !error.memberTasks">
          <!-- No Tasks Message -->
          <div *ngIf="selectedModalMemberTasks.length === 0" class="text-center py-4">
            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
            <p class="mt-3 text-muted">No tasks assigned to {{ selectedModalMemberName }}</p>
          </div>
          
          <!-- Task List -->
          <ul class="member-task-list" *ngIf="selectedModalMemberTasks.length > 0">
            <li *ngFor="let task of selectedModalMemberTasks" class="task-item">
              <div class="task-header">
                <a href="#" (click)="openTaskInAzureDevOps(task.id, $event)" class="task-id">#{{ task.id }}</a>
                <span class="task-status" [ngClass]="getStatusClass(task.status)">{{ task.status }}</span>
              </div>
              <div class="task-title">{{ task.title }}</div>
            </li>
          </ul>
        </div>
        
        <div class="member-modal-footer">
          <button type="button" class="member-modal-btn primary" (click)="closeMemberModal()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div> 